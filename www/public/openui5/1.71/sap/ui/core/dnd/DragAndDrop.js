/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","../UIArea","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(D,U,q){"use strict";var a={},d=null,o=null,v=null,V=[],b=[],c=null,$,e,g,C,t,l={};function f(E,S){if(!E){return;}if(E.addStyleClass){E.addStyleClass(S);}else{E.$().addClass(S);}}function r(E,S){if(!E){return;}if(E.removeStyleClass){E.removeStyleClass(S);}else{E.$().removeClass(S);}}function h(E,i){var A=q(E.target).control(0,true);if(!A){return;}var N=q.Event(null,E);N.type=i;A.getUIArea()._handleEvent(N);}function s(d,E){if(D.browser.msie||!d||!d.getDragGhost){return;}var i=d.getDragGhost();if(!i){return;}if(!g){g=q('<div class="sapUiDnDGhostContainer"></div>');q(document.body).append(g);}g.append(i);window.setTimeout(function(){g.empty();},0);var O=E.originalEvent;O.dataTransfer.setDragImage(i,O.offsetX,O.offsetY);}function j(E){var i={},I,A=E.originalEvent.dataTransfer,B=function(T,F){if(A&&T=="text"||(D.browser!="msie"&&D.browser!="edge")){A.setData(T,F);}};return{setData:function(K,F){F=""+F;i[K]=F;B(K,F);},getData:function(K){return i[K];},setTextData:function(F){F=""+F;i["text/plain"]=F;i["text"]=F;B("text/plain",F);B("text",F);},getTextData:function(){return i["text/plain"];},setComplexData:function(K,F){i[K]=F;},getComplexData:function(K){return i[K];},getIndicator:function(){return $&&$[0];},setIndicatorConfig:function(F){I=F;},getIndicatorConfig:function(F){return I;},getDragControl:function(){return d;},getDropControl:function(){return v;},setDropControl:function(F){v=F;},getDropInfo:function(){return b[0]||null;},getDropPosition:function(){return C;}};}function k(E){n();r(d,"sapUiDnDDragging");d=o=v=c=null;C="";V=[];b=[];}function m(){if($){return $;}if(!D.browser.msie){e=q("<div class='sapUiDnDIndicatorWrapper'></div>");}$=q("<div class='sapUiDnDIndicator'></div>");if(!e){q(sap.ui.getCore().getStaticAreaRef()).append($);}else{q(sap.ui.getCore().getStaticAreaRef()).append(e);$.appendTo(e);}return $;}function n(){if($){$.removeAttr("style").hide();l={};}}function p(E,i,A,B){if(!i){return;}var I=E.dragSession&&E.dragSession.getIndicatorConfig(),F=i.getBoundingClientRect(),P=window.pageYOffset,G=window.pageXOffset,H=m(),R,S={},J={top:F.top+P,bottom:F.bottom+P,left:F.left+G,right:F.right+G,width:F.width,height:F.height};if(!A||A=="On"){R="On";B="";}else if(B=="Horizontal"){var K=E.pageX-J.left;S.height=J.height;S.top=J.top;if(A=="Between"){S.width="";if(K<J.width*0.5){R="Before";S.left=J.left;}else{R="After";S.left=J.right;}}else if(A=="OnOrBetween"){if(K<J.width*0.25){R="Before";S.left=J.left;S.width="";}else if(K>J.width*0.75){R="After";S.left=J.right;S.width="";}else{R="On";}}if(R!="On"&&sap.ui.getCore().getConfiguration().getRTL()){R=(R=="After")?"Before":"After";}}else{var L=E.pageY-J.top;S.width=J.width;S.left=J.left;if(A=="Between"){S.height="";if(L<J.height*0.5){R="Before";S.top=J.top;}else{R="After";S.top=J.bottom;}}else if(A=="OnOrBetween"){if(L<J.height*0.25){R="Before";S.top=J.top;S.height="";}else if(L>J.height*0.75){R="After";S.top=J.bottom;S.height="";}else{R="On";}}}if(I&&I.display=="none"){return R;}if(R=="On"){S.top=J.top;S.left=J.left;S.width=J.width;S.height=J.height;A=R;}else{A="Between";}if(l.top!=S.top||l.left!=S.left||l.width!=S.width||l.height!=S.height){H.attr("data-drop-layout",B);H.attr("data-drop-position",A);H.css(q.extend(S,I)).show();l=S;}return R;}function u(i){var P=i.getParent(),S=(i.getDragDropConfig)?i.getDragDropConfig():[],A=(P&&P.getDragDropConfig)?P.getDragDropConfig():[];return S.concat(A);}function w(d){var i=u(d);return i.filter(function(A){return A.isDraggable(d);});}function x(o,i,E){var A=u(o);i=i||[];return A.filter(function(B){return!B.isA("sap.ui.core.dnd.IDragInfo");}).concat(i).filter(function(B){if(!B.isDroppable(o,E)){return false;}var F=B.getGroupName();if(!F){return true;}return i.some(function(G){return G.getGroupName()==F;});});}function y(E,i){E.preventDefault();var A=i.getDropEffect().toLowerCase();E.originalEvent.dataTransfer.dropEffect=A;}function z(E,i,v){var T=i.getTargetAggregation();if(!T){return p(E,v.getDomRef());}var A;if(E.getMark("DragWithin")==T){A=v.getDomRefForSetting(T);}A=A||v.getDomRef();return p(E,A,i.getDropPosition(true),i.getDropLayout(true));}a.preprocessEvent=function(E){if(c&&E.type.indexOf("dr")==0){E.dragSession=c;}var i="onbefore"+E.type;if(a[i]){a[i](E);}};a.postprocessEvent=function(E){var i="onafter"+E.type;if(a[i]){a[i](E);}};a.onbeforedragstart=function(E){if(!E.target.draggable){return;}if(/^(input|textarea)$/i.test(document.activeElement.tagName)){E.target.getAttribute("data-sap-ui-draggable")&&E.preventDefault();return;}d=q(E.target).control(0,true);if(!d){return;}V=w(d);if(!V.length){return;}if(D.browser.firefox&&E.originalEvent.dataTransfer.types.length===0){E.originalEvent.dataTransfer.setData("ui5/dummyDataForFirefox","data");}E.dragSession=c=j(E);};a.onafterdragstart=function(E){if(!V.length||E.isDefaultPrevented()){k();return;}V=E.isMarked("NonDraggable")?[]:V.filter(function(i){return i.fireDragStart(E);});if(!V.length){E.preventDefault();k();return;}s(d,E);f(d,"sapUiDnDDragging");};a.onbeforedragenter=function(E){var A=q(E.target).control(0,true);if(A&&o===A){E.setMark("DragWithin","SameControl");}else{t=Date.now();o=A;}var B=[];v=A;for(var i=0;i<20&&v;i++,v=v.getParent()){B=x(v,V,E);if(B.length){break;}}if(E.getMark("DragWithin")!="SameControl"){b=B;if(c){c.setIndicatorConfig(null);}}if(!b.length){v=null;}else if(!c){E.dragSession=c=j(E);}};a.onafterdragenter=function(E){if(!v||E.isMarked("NonDroppable")){b=[];}else if(E.getMark("DragWithin")!="SameControl"){b=b.filter(function(A){return A.fireDragEnter(E);});}var i=b[0];if(!i||i.getDropEffect()=="None"){n();C="";}else{y(E,i);C=z(E,i,v);}};a.onbeforedragover=function(E){var i=Date.now();if(i-t>=1000){h(E,"longdragover");t=i;}};a.onafterdragover=function(E){var i=b[0];if(!i||i.getDropEffect()=="None"){return;}b.forEach(function(A){A.fireDragOver(E);});y(E,i);if(i&&i.getDropPosition(true)=="On"){return;}C=z(E,i,v);};a.onbeforedrop=function(E){if(b.length){E.preventDefault();}};a.onafterdrop=function(E){b.forEach(function(i){i.fireDrop(E);});this.iDragEndTimer=window.requestAnimationFrame(this.onafterdragend.bind(this,E));};a.onafterdragend=function(E){this.iDragEndTimer=window.cancelAnimationFrame(this.iDragEndTimer);V.forEach(function(i){i.fireDragEnd(E);});k();};U.addEventPreprocessor(a.preprocessEvent);U.addEventPostprocessor(a.postprocessEvent);return a;},true);
