/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/descriptorRelated/api/DescriptorVariantFactory","sap/ui/fl/transport/TransportSelection","sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/Utils","sap/ui/fl/Change","sap/base/Log","sap/base/util/includes","sap/base/util/merge"],function(D,T,a,C,U,b,L,i,m){"use strict";function _(P){if(P&&P.package&&P.transport&&P.selector&&P.selector.appId){return Promise.resolve({packageName:P.package,transport:P.transport});}return Promise.resolve({packageName:"",transport:""});}function c(A,t){if(t){if(t.transport&&t.packageName!=="$TMP"){return A.setTransportRequest(t.transport).then(A.setPackage(t.packageName));}return Promise.resolve();}return Promise.reject();}function d(q){var I=[];q.forEach(function(r){var s=r.getDefinition();I.push(a.createNew(s.changeType,s.content,s.texts));});return Promise.all(I);}function e(q,A){var P={reference:A.getId()};var s=U.createNamespace(P,"changes");q.setNamespace(s);q.setComponent(A.getId());if(A.getVersion()){q.setValidAppVersions({creation:A.getVersion(),from:A.getVersion()});}}function f(A,q){var r=[];A.forEach(function(I){I.replaceHostingIdForTextKey(q.getId(),q.getReference(),I.getContent(),I.getTexts());r.push(q.addDescriptorInlineChange(I));});return Promise.all(r);}function g(A){var t=new T();return t.openTransportSelection(A);}function h(A,P){if(P&&P.transport&&P.selector&&P.selector.appId){return Promise.resolve({packageName:A.getPackage(),transport:P.transport});}return g(A);}function j(s){var q=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;if(q){var r=q.getDirtyChanges();r=r.slice();return r;}return[];}function k(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;if(F){var u=F.getDirtyChanges();u=u.slice();return u;}return[];}function l(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;var q=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;return F===q;}function n(s,A,q){var r=[];if(A){j(s).forEach(function(t){if(i(a.getDescriptorChangeTypes(),t.getDefinition().changeType)){r.push(t);}else{e(t,q);}});}else{k(s).forEach(function(t){e(t,q);});r=j(s);}return r;}function o(s){j(s).forEach(function(q){if(i(a.getDescriptorChangeTypes(),q.getChangeType())){C.getDescriptorFlexControllerInstance(s)._oChangePersistence.deleteChange(q);}});}function p(A){return new b({fileName:A.getDefinition().fileName,fileType:A.getDefinition().fileType,packageName:A.getPackage(),namespace:A.getNamespace()});}var S={saveAs:function(P){var A;var q;var r=false;return D.createAppVariant(P).then(function(s){A=m({},s);return _(P);}).then(function(t){return c(A,t);}).then(function(){r=l(P.selector);var s=n(P.selector,r,A);return d(s);}).then(function(s){return f(s,A);}).then(function(){return A.submit().catch(function(E){E.messageKey="MSG_SAVE_APP_VARIANT_FAILED";E.saveAsFailed=true;throw E;});}).then(function(R){q=m({},R);if(r){o(P.selector);}var F=C.getFlexControllerInstance(P.selector);var u=k(P.selector);if(u.length){return F.saveAll(true).catch(function(E){if(r){o(P.selector);}return this.deleteAppVar({referenceAppId:P.id}).then(function(){E.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw E;});}.bind(this));}return Promise.resolve();}.bind(this)).then(function(){if(!r){o(P.selector);}return q;}).catch(function(E){L.error("the app variant could not be created.",E.message||E.name);throw E;});},deleteAppVar:function(P){var A;return D.loadAppVariant(P.referenceAppId,true).catch(function(E){E.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw E;}).then(function(q){A=m({},q);var r=p(q);return h(r,P);}).then(function(t){if(t==="cancel"){return Promise.reject("cancel");}if(t){if(t.transport){return A.setTransportRequest(t.transport);}return t;}throw new Error("Transport information could not be determined");}).then(function(){return A.submit().catch(function(E){E.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw E;});}).catch(function(E){if(E!=="cancel"){L.error("the app variant could not be deleted.",E.message||E.name);throw E;}});}};return S;},true);
